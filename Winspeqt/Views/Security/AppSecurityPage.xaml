<Page
    x:Class="Winspeqt.Views.Security.AppSecurityPage"
    x:Name="PageRoot"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:Winspeqt.Models"
    xmlns:helpers="using:Winspeqt.Helpers"
    mc:Ignorable="d">

    <Page.Resources>
        <helpers:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
    </Page.Resources>

    <ScrollViewer>
        <Grid Padding="60">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Header with Back Button -->
            <Grid Grid.Row="0" Margin="0,0,0,24">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <Button 
                Grid.Column="0"
                Content="â† Back"
                Click="BackButton_Click"
                Background="Transparent"
                BorderThickness="0"
                FontSize="16"
                Margin="0,0,20,0"
                VerticalAlignment="Center"/>

                <StackPanel Grid.Column="1" Spacing="8" VerticalAlignment="Center">
                    <TextBlock 
                    Text="App Update Checker" 
                    Style="{StaticResource TitleTextBlockStyle}"
                    FontSize="32"
                    FontWeight="SemiBold"/>
                    <TextBlock 
                    Text="Find out which apps need updates to stay secure and run smoothly"
                    Style="{StaticResource BodyTextBlockStyle}"
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                </StackPanel>
            </Grid>

            <!-- Info Banner -->
            <Border 
            Grid.Row="1"
            Background="{ThemeResource LayerFillColorDefaultBrush}"
            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
            BorderThickness="1"
            CornerRadius="6"
            Padding="12"
            Margin="0,0,0,24">
                <StackPanel Spacing="4">
                    <TextBlock 
                    Text="â„¹ï¸ Good to know"
                    FontWeight="SemiBold"
                    FontSize="13"
                    Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"/>
                    <TextBlock 
                    Text="We check online databases to find the latest versions. Results are usually accurate, but it's always good to double-check for important apps."
                    TextWrapping="Wrap"
                    FontSize="13"
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                </StackPanel>
            </Border>

            <!-- Scan Button & Status -->
            <Grid Grid.Row="2" Margin="0,0,0,24">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <Button 
                x:Name="ScanButton"
                Grid.Column="0"
                Content="ðŸ” Check for Updates"
                Command="{x:Bind ViewModel.ScanCommand}"
                Style="{StaticResource AccentButtonStyle}"
                Padding="24,12"
                FontSize="16"
                Margin="0,0,16,0"/>

                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                    <ProgressRing 
                    x:Name="ScanningProgress"
                    Width="24" 
                    Height="24"
                    Visibility="Collapsed"/>
                    <TextBlock 
                    x:Name="StatusText"
                    Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}"
                    Style="{StaticResource BodyTextBlockStyle}"
                    VerticalAlignment="Center"/>
                </StackPanel>
            </Grid>

            <!-- Summary Card -->
            <Border
            x:Name="SummaryCard"
            Grid.Row="3" 
            Margin="0,0,0,24"
            Visibility="Collapsed"
            Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
            BorderThickness="1"
            CornerRadius="8"
            Padding="20">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Summary Message -->
                    <TextBlock 
                    Grid.Column="0"
                    Text="{x:Bind ViewModel.SummaryMessage, Mode=OneWay}"
                    Style="{StaticResource BodyTextBlockStyle}"
                    FontSize="16"
                    TextWrapping="Wrap"
                    VerticalAlignment="Center"/>

                    <!-- Stats -->
                    <StackPanel 
                    Grid.Column="1" 
                    Orientation="Horizontal" 
                    Spacing="24"
                    Margin="20,0,0,0">

                        <!-- Critical -->
                        <StackPanel x:Name="CriticalStack" Spacing="4" Visibility="Collapsed">
                            <TextBlock 
                            Text="ðŸ”´"
                            FontSize="24"
                            HorizontalAlignment="Center"/>
                            <TextBlock 
                            Text="{x:Bind ViewModel.CriticalAppsCount, Mode=OneWay}"
                            FontSize="20"
                            FontWeight="Bold"
                            HorizontalAlignment="Center"/>
                            <TextBlock 
                            Text="Critical"
                            FontSize="12"
                            Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                            HorizontalAlignment="Center"/>
                        </StackPanel>

                        <!-- Outdated -->
                        <StackPanel x:Name="OutdatedStack" Spacing="4" Visibility="Collapsed">
                            <TextBlock 
                            Text="âš ï¸"
                            FontSize="24"
                            HorizontalAlignment="Center"/>
                            <TextBlock 
                            Text="{x:Bind ViewModel.OutdatedAppsCount, Mode=OneWay}"
                            FontSize="20"
                            FontWeight="Bold"
                            HorizontalAlignment="Center"/>
                            <TextBlock 
                            Text="Outdated"
                            FontSize="12"
                            Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                            HorizontalAlignment="Center"/>
                        </StackPanel>

                        <!-- Up to Date -->
                        <StackPanel Spacing="4">
                            <TextBlock 
                            Text="âœ“"
                            FontSize="24"
                            HorizontalAlignment="Center"
                            Foreground="#4CAF50"/>
                            <TextBlock 
                            Text="{x:Bind ViewModel.UpToDateAppsCount, Mode=OneWay}"
                            FontSize="20"
                            FontWeight="Bold"
                            HorizontalAlignment="Center"/>
                            <TextBlock 
                            Text="Up to Date"
                            FontSize="12"
                            Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                            HorizontalAlignment="Center"/>
                        </StackPanel>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Apps List -->
            <Grid x:Name="AppsList" Grid.Row="4" Visibility="Collapsed">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Filter -->
                <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="16" Margin="0,0,0,16">
                    <ComboBox 
                    Header="Filter"
                    ItemsSource="{x:Bind ViewModel.FilterOptions}"
                    SelectedItem="{x:Bind ViewModel.FilterOption, Mode=TwoWay}"
                    Width="200"
                    FontSize="15"/>

                    <ToggleButton
                    x:Name="ShowTechnicalToggle"
                    Content="ðŸ”§ Show Technical Details"
                    Padding="12,8"
                    FontSize="14"
                    VerticalAlignment="Bottom"
                    Margin="0,0,0,2"/>
                </StackPanel>

                <!-- List -->
                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{x:Bind ViewModel.FilteredApps, Mode=OneWay}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="models:AppSecurityInfo">
                                <Border 
                                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                BorderThickness="1"
                                CornerRadius="8"
                                Padding="20"
                                Margin="0,0,0,12">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Status Icon -->
                                        <TextBlock 
                                        Grid.Column="0"
                                        Text="{x:Bind StatusIcon}"
                                        FontSize="32"
                                        VerticalAlignment="Center"
                                        Margin="0,0,16,0"/>

                                        <!-- App Info -->
                                        <StackPanel Grid.Column="1" Spacing="6" VerticalAlignment="Center">
                                            <TextBlock 
                                            Text="{x:Bind AppName}"
                                            Style="{StaticResource BodyStrongTextBlockStyle}"
                                            FontSize="17"/>

                                            <!-- Simple status message -->
                                            <TextBlock 
                                            Text="{x:Bind StatusMessage}"
                                            Style="{StaticResource BodyTextBlockStyle}"
                                            FontSize="14"
                                            TextWrapping="Wrap"/>

                                            <!-- Version info - simplified -->
                                            <TextBlock 
                                            Style="{StaticResource CaptionTextBlockStyle}"
                                            Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                            FontSize="13">
                                            <Run Text="Your version:"/>
                                            <Run Text="{x:Bind InstalledVersion}" FontWeight="SemiBold"/>
                                            </TextBlock>

                                            <!-- Technical Details (hidden by default) -->
                                            <StackPanel 
                                            Spacing="4" 
                                            Margin="0,8,0,0"
                                            Visibility="{Binding ElementName=ShowTechnicalToggle, Path=IsChecked}">

                                                <Border 
                                                Background="{ThemeResource LayerFillColorDefaultBrush}"
                                                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                                BorderThickness="1"
                                                CornerRadius="4"
                                                Padding="8">
                                                    <StackPanel Spacing="4">
                                                        <TextBlock 
                                                        Text="Technical Information"
                                                        FontSize="11"
                                                        FontWeight="SemiBold"
                                                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>

                                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                                            <Border 
                                                            Background="{x:Bind ConfidenceColor}"
                                                            CornerRadius="3"
                                                            Padding="6,2">
                                                                <TextBlock 
                                                                FontSize="11"
                                                                FontWeight="SemiBold"
                                                                Foreground="White">
                                                                <Run Text="Confidence:"/>
                                                                <Run Text="{x:Bind ConfidenceLevel}"/>
                                                                <Run Text="("/>
                                                                <Run Text="{x:Bind ConfidenceScore}"/>
                                                                <Run Text="%)"/>
                                                                </TextBlock>
                                                            </Border>
                                                        </StackPanel>

                                                        <TextBlock 
                                                        Style="{StaticResource CaptionTextBlockStyle}"
                                                        FontSize="11"
                                                        Foreground="{ThemeResource TextFillColorSecondaryBrush}">
                                                        <Run Text="Latest version:"/>
                                                        <Run Text="{x:Bind LatestVersion}" FontWeight="SemiBold"/>
                                                        </TextBlock>

                                                        <TextBlock 
                                                        Text="{x:Bind DataSource}"
                                                        Style="{StaticResource CaptionTextBlockStyle}"
                                                        Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                                        FontSize="10"/>

                                                        <TextBlock 
                                                        Style="{StaticResource CaptionTextBlockStyle}"
                                                        FontSize="11"
                                                        Foreground="{ThemeResource TextFillColorSecondaryBrush}">
                                                        <Run Text="Publisher:"/>
                                                        <Run Text="{x:Bind Publisher}"/>
                                                        </TextBlock>

                                                        <TextBlock 
                                                        Style="{StaticResource CaptionTextBlockStyle}"
                                                        FontSize="11"
                                                        Foreground="{ThemeResource TextFillColorSecondaryBrush}">
                                                        <Run Text="Installed:"/>
                                                        <Run Text="{x:Bind FormattedInstallDate}"/>
                                                        </TextBlock>
                                                    </StackPanel>
                                                </Border>
                                            </StackPanel>
                                        </StackPanel>

                                        <!-- Update Button -->
                                        <Button 
                                        Grid.Column="2"
                                        Content="Update"
                                        Command="{Binding ElementName=PageRoot, Path=ViewModel.OpenUpdateInstructionsCommand}"
                                        CommandParameter="{x:Bind}"
                                        Visibility="{x:Bind IsOutdated, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                                        Style="{StaticResource AccentButtonStyle}"
                                        VerticalAlignment="Center"
                                        Padding="20,10"
                                        Margin="16,0,0,0"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>

            <!-- Empty State -->
            <StackPanel 
            x:Name="EmptyState"
            Grid.Row="3"
            HorizontalAlignment="Center"
            VerticalAlignment="Center"
            Spacing="16">
                <TextBlock 
                Text="ðŸ“±"
                FontSize="72"
                HorizontalAlignment="Center"
                Opacity="0.5"/>
                <TextBlock 
                Text="Ready to check your apps"
                Style="{StaticResource SubtitleTextBlockStyle}"
                HorizontalAlignment="Center"
                Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                <TextBlock 
                Text="Click the button above to see which apps need updates"
                Style="{StaticResource BodyTextBlockStyle}"
                HorizontalAlignment="Center"
                Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
            </StackPanel>
        </Grid>
    </ScrollViewer>
</Page>